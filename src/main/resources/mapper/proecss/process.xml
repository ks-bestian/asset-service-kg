<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper">


    <!-- 프로세스정의 -->
	<insert id="insertBpDefine" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.insertBpDefine */
	INSERT INTO EBS_BP_DEFINE
	     (
	       BP_DF_ID
	     , BP_DF_NM
	     , RMK
	     , REG_ID
	     , REG_DT
	     , MOD_ID
	     , MOD_DT
	     )
	VALUES
	     (
	       #{BP_DF_ID}
	     ,  #{BP_DF_NM}
	     ,  #{RMK}
	     ,  #{REG_ID}
	     ,  now()
	    )
	</insert>

   <select id="selectBpDefine"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   	    resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectBpDefine */
	SELECT
	        BP_DF_ID
	     ,  BP_DF_NM
	     ,  RMK
	     ,  REG_ID
	     ,  REG_DT
	     ,  MOD_ID
	     ,  MOD_DT
	  FROM EBS_BP_DEFINE
	 WHERE BP_DF_ID = #{BP_DF_ID}
	   AND BP_DF_NM = #{BP_DF_NM}
	</select>

    <update id="updateBpDefine" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateBpDefine */
	UPDATE EBS_BP_DEFINE
	   SET
	       BP_DF_ID = #{BP_DF_ID}
	     , BP_DF_NM = #{BP_DF_NM}
	     , RMK = #{RMK}
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	 WHERE bp_df_id = #{bp_df_id}
    </update>

    <delete id="deleteBpDefine" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.deleteBpDefine */
	DELETE FROM EBS_BP_DEFINE
	WHERE bp_df_id = #{bp_df_id}
    </delete>




    <!-- 프로세스 인스턴스 -->
	<insert id="insertBpInstance" useGeneratedKeys="true" keyProperty="bpInstanceId"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.insertBpInstance */
	INSERT INTO EBS_BP_INSTANCE
	     (
	       BILL_ID
	     , BP_DF_ID
	     , START_DT
	     , STATUS
	     , CURRENT_STEP_ID
	     , REG_ID
	     , REG_DT
	     )
	VALUES
	     (
	        #{billId}
	     ,  #{bpDfId}
	     ,  now()
	     ,  #{status}
	     ,  #{currentStepId}
	     ,  #{regId}
	     ,  now()
	    )
	</insert>

   <select id="selectBpInstance"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectBpInstance */
	SELECT
	        BP_INSTANCE_ID
	     ,  BILL_ID
	     ,  BP_DF_ID
	     ,  START_DT
	     ,  END_DT
	     ,  STATUS
	     ,  CURRENT_STEP_ID
	     ,  REG_ID
	     ,  REG_DT
	     ,  MOD_ID
	     ,  MOD_DT
	  FROM EBS_BP_INSTANCE
	 WHERE BILL_ID = #{billId}

	</select>



    <update id="updateBpInstanceCurrentStep" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateBpInstanceCurrentStep */
	UPDATE EBS_BP_INSTANCE
	   SET
	       CURRENT_STEP_ID = #{currentStepId}
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	 WHERE BP_INSTANCE_ID = #{bpInstanceId}
    </update>

    <update id="updateEndBpInstance" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateEndBpInstance */
	UPDATE EBS_BP_INSTANCE
	   SET
	       END_DT = now()
	     , STATUS = 'C'
	     , CURRENT_STEP_ID = #{currentStepId}
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	 WHERE BP_INSTANCE_ID = #{bpInstanceId}
    </update>

    <update id="updateBpInstance" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateBpInstance */
	UPDATE EBS_BP_INSTANCE
	   SET
	       BP_DF_ID = #{bpDfId}
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	 WHERE BILL_ID = #{billId}
    </update>

    <delete id="deleteBpInstance" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.deleteBpInstance */
	DELETE FROM EBS_BP_INSTANCE
	WHERE BP_INSTANCE_ID = #{bpInstanceId}
    </delete>




    <!-- 프로세스 서비스정의 -->
	<insert id="insertBpService" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.insertBpService */
	INSERT INTO EBS_BP_SERVICE
	     (
	       STEP_ID
	     , STEP_NM
	     , RMK
	     , REG_ID
	     , REG_DT
	     )
	VALUES
	     (
	        #{STEP_ID}
	     ,  #{STEP_NM}
	     ,  #{RMK}
	     ,  #{REG_ID}
	     ,  now()
	    )
	</insert>

   <select id="selectBpService"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectBpService */
	SELECT
	        STEP_ID
	     ,  STEP_NM
	     ,  RMK
	     ,  REG_ID
	     ,  REG_DT
	     ,  MOD_ID
	     ,  MOD_DT
	FROM EBS_BP_SERVICE
	WHERE STEP_ID = #{STEP_ID}
	</select>

    <update id="updateBpService" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateBpService */
	UPDATE EBS_BP_SERVICE
	   SET
	       STEP_NM = #{STEP_NM}
	     , RMK = #{RMK}
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	 WHERE STEP_ID = #{STEP_ID}

    </update>

    <delete id="deleteBpService" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.deleteBpService */
	DELETE FROM EBS_BP_SERVICE
	WHERE STEP_ID = #{STEP_ID}
    </delete>





    <!-- 프로세스 스텝정의 -->
	<insert id="insertBpStep" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.insertBpStep */
	INSERT INTO EBS_BP_STEP
	     (
	       STEP_ID
	     , BP_DF_ID
	     , STEP_NM
	     , NEXT_STEP_ID
	     , STEP_TYPE
	     , RMK
	     , REQ_AUTH_ID
	     , STEP_ORD
	     , REG_ID
	     , REG_DT
	     )
	VALUES
	     (
	        #{STEP_ID}
	     ,  #{BP_DF_ID}
	     ,  #{STEP_NM}
	     ,  #{NEXT_STEP_ID}
	     ,  #{STEP_TYPE}
	     ,  #{RMK}
	     ,  #{REQ_AUTH_ID}
	     ,  #{STEP_ORD}
	     ,  #{REG_ID}
	     ,  now()
	    )

	</insert>

   <select id="selectListBpStep"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectListBpStep */
   SELECT
            STEP_ID
	     ,  BP_DF_ID
	     ,  STEP_NM
	     ,  NEXT_STEP_ID
	     ,  RMK
	     ,  REQ_AUTH_ID
	     ,  STEP_ORD
	FROM EBS_BP_STEP
	WHERE BP_DF_ID = (select bp_df_id from ebs_bp_instance where bill_id = #{billId})
	order by STEP_ORD
	</select>

   <select id="selectBpStep"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectBpStep */
	SELECT
           A.STEP_ID
	     , A.BP_DF_ID
	     , A.STEP_NM
	     , A.NEXT_STEP_ID
	     , A.RMK
	     , A.REQ_AUTH_ID
	     , A.STEP_ORD
	     , B.bp_instance_id
	     , B.bill_id
	FROM EBS_BP_STEP A, ebs_bp_instance B
	WHERE A.BP_DF_ID = B.BP_DF_ID
		and A.STEP_ID = #{stepId}
		and B.bill_id = #{billId}
	</select>

   <select id="selectBpStepList"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectBpStepList */
	SELECT
           A.STEP_ID
	     , A.BP_DF_ID
	     , A.STEP_NM
	     , A.NEXT_STEP_ID
	     , A.RMK
	     , A.REQ_AUTH_ID
	     , A.STEP_ORD
	     , B.bp_instance_id
	     , B.bill_id
	FROM EBS_BP_STEP A, ebs_bp_instance B
	WHERE A.BP_DF_ID = B.BP_DF_ID
		and B.bill_id = #{billId}
	</select>

    <update id="updateBpStep" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateBpStep */
	UPDATE EBS_BP_STEP
	   SET
	       STEP_ID = #{STEP_ID}
	     , BP_DF_ID = #{BP_DF_ID}
	     , STEP_NM = #{STEP_NM}
	     , NEXT_STEP_ID = #{NEXT_STEP_ID}
	     , STEP_TYPE = #{STEP_TYPE}
	     , RMK = #{RMK}
	     , REQ_AUTH_ID = #{REQ_AUTH_ID}
	     , STEP_ORD = #{STEP_ORD}
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	WHERE STEP_ID = #{STEP_ID}
	   AND BP_DF_ID = #{BP_DF_ID}

    </update>

    <delete id="deleteBpStep" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.deleteBpStep */
	DELETE FROM EBS_BP_STEP
	WHERE STEP_ID = #{STEP_ID}
	   AND BP_DF_ID = #{BP_DF_ID}
    </delete>




    <!-- 프로세스 타스크 -->
	<insert id="insertBpTask" useGeneratedKeys="true" keyProperty="taskId" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.insertBpTask */
	INSERT INTO EBS_BP_TASKS
	     (
	       TASK_NM
	     , BP_INSTANCE_ID
	     , STEP_ID
	     , ASSIGNED_TO
	     , TRGT_USER_ID
	     , STATUS
	     , DUE_DT
	     , BILL_APRV_NO
	     , REG_ID
	     , REG_DT
	     )
	VALUES
	     (
	        #{taskNm}
	     ,  #{bpInstanceId}
	     ,  #{stepId}
	     ,  #{assignedTo}
	     ,  #{trgtUserId}
	     ,  #{status}
	     ,  #{dueDt}
	     ,  #{billAprvNo}
	     ,  #{regId}
	     ,  now()
	    )

	</insert>

   <select id="selectBpTasks"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
    resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectBpTasks */
	SELECT
	        TASK_ID
	     ,  TASK_NM
	     ,  BP_INSTANCE_ID
	     ,  STEP_ID
	     ,  ASSIGNED_TO
	     ,  STATUS
	     ,  DUE_DT
	     ,  COMPLETED_DT
	     ,  BILL_APRV_NO
	     ,  REG_ID
	     ,  REG_DT
	     ,  MOD_ID
	     ,  MOD_DT
	  FROM EBS_BP_TASKS
	 WHERE TASK_ID = #{TASK_ID}
	   AND BP_INSTANCE_ID = #{BP_INSTANCE_ID}

	</select>

    <update id="updateBpTask" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.updateBpTask */
	 UPDATE EBS_BP_TASKS
	   SET
	       STATUS = #{status}
	     , COMPLETED_DT = now()
	     , MOD_ID = #{modId}
	     , MOD_DT = now()
	 WHERE TASK_ID = #{taskId}


    </update>

    <delete id="deleteBpTasks" parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
	/* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.deleteBpTasks */
	DELETE FROM EBS_BP_TASKS
	WHERE TASK_ID = #{TASK_ID}
	   AND STEP_ID = #{STEP_ID}
	   AND BP_INSTANCE_ID = #{BP_INSTANCE_ID}
    </delete>

   <!-- 해당안건의 소관위 -->
   <select id="selectOneCmtt"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
    resultType="kr.co.bestiansoft.ebillservicekg.process.vo.CmttVo">
   /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectOneCmtt */
	select
		bill_id
	  , cmt_id
	from ebs_cmt
	where bill_id = #{billId}
	  and cmt_type = 'M'

	</select>



  <!-- 해당안건의 공동발의자 목록 -->
   <select id="selectListProposerId"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   	    resultType="kr.co.bestiansoft.ebillservicekg.bill.review.billMng.vo.ProposerVo">
   	    /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectListProposerId */
		select
		    bill_id
		  , proposer_id
		from ebs_proposer
		where bill_id = #{billId}

	</select>


  <!-- 서비스별 버튼권한 목록 -->
   <select id="selectListSrvcJobAuth"  parameterType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo"
   	    resultType="kr.co.bestiansoft.ebillservicekg.process.vo.ProcessVo">
   	    /* QueryID : kr.co.bestiansoft.ebillservicekg.process.repository.ProcessMapper.selectListSrvcJobAuth */
		select
		    srvc_cd
		  , job_cd
		from ebs_bp_srvc_job
		where use_yn = 'Y'
	</select>



</mapper>